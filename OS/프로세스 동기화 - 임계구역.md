# 프로세스 동기화 - 임계구역

## 1. 프로세스 동기화 (Process Synchronization)

- 실질적으로는 Tread synchronization
- Independent vs Cooperating
- Cooperating Process 일 경우 발생 가능한 문제점을 해결하기 위해 프로세스 동기화 진행
    - 공유 데이터에 대한 동시 액세스로 인해 데이터 불일치 문제
    - 예를 들어, 하나의 기차표 예약 서비스가 있다고 한다면 여러 사용자들이 한꺼번에 해당 서버에 접근하려고 할 때 똑같은 좌석에 두 명 이상의 사람이 예약되는 문제가 발생할 수 있다. 이를 해결하기 위해 Cooperating Process을 순서대로 실행하여 데이터의 일관성을 유지하게 한다.
    

## 2. 프로세스 동기화 필요성

### 1. Thread 주요 메서드

- **`public void run()`** : 새로운 맥이 흐르는 곳 (치환)
- **`void start()`** : 스레드 시작 요청
- **`void join()`** : 스레드가 마치기를 기다림
- **`static void sleep()`** : 스레드 잠자기

### 2. 은행 계좌 문제 예제

- 예제 코드
    
    ```java
    package synchronization;
    
    public class BankAccount {
    	int balance;
    	void deposit(int n) {
    		int temp = balance + n;
    		System.out.print("+");
    		balance = temp;
    	}
    	void withdraw(int n) {
    		int temp = balance - n;
    		System.out.print("-");
    		balance = temp;
    	}
    	int getBalance() {
    		return balance;
    	}
    }
    ```
    
    ```java
    package synchronization;
    
    public class Parent extends Thread{
    	BankAccount b;
    	Parent(BankAccount b){
    		this.b = b;
    	}
    	public void run() {
    		for(int i = 0 ; i < 1000; i++) {
    			b.deposit(1000);
    		}
    	}
    }
    ```
    
    ```java
    package synchronization;
    
    public class Child extends Thread {
    	BankAccount b;
    	Child(BankAccount b){
    		this.b = b;
    	}
    	public void run() {
    		for(int i = 0; i < 10000; i++) {
    			b.withdraw(1000);
    		}
    	}
    }
    ```
    
    ```java
    package synchronization;
    
    public class Test {
    
    	public static void main(String[] args) throws InterruptedException {
    		BankAccount b = new BankAccount();
    		Parent p = new Parent(b);
    		Child c = new Child(b);
    		p.start();
    		c.start();
    		p.join();
    		c.join();
    		System.out.println("\n");
    		System.out.println("balance =" + b.getBalance());
    	}
    }
    ```
    
- 예제 결과
    - 1 번째 실행
        
        ```
        ++++++++++++-----------------------------------++++++++++++++++++++++++++++----------------------------------------------------------------------------------++++++++++++++++++++++++++++++++++++++++++++++----------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        
        balance =-1000000
        ```
        
    - 2 번째 실행
        
        ```
        +++++++++++-----------------------------------++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++------------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        
        balance =360000
        ```
        
    - 3번째 실행
        
        ```
        ------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------++++++++++++++++++++------------------------------------------------++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------------------++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-++++-++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------
        
        balance =405000
        ```
        
    - 매번 재실행시마다 다른 값을 출력하는 문제 발생. 해당 로직은 문제가 없으나 시간 지연이 값을 다르게 출력하게끔 문제를 발생 시켰다. 프로그램은 언제든지 시간 지연이 존재할 수 있고 이러한 지연에도 불구하고 결과는 똑바로 나와야 한다. 그렇다면 이러한 문제는 왜 일어나고, 어떻게 해결할 수 있을까?
    

## 3. 임계구역(Critical Section)

### 1. 임계구역이란?

- 여러개의 스레드로 이루어진 시스템에서 스레드들이 공통으로 사용하는 변수를 업데이트 하는 구간. 코드
    
    ```java
    // 임계영역 1
    balance = balance + n;
    
    // 임계영역 2
    balance = balance - n;
    ```
    

### 2. 데이터 불일치 발생 이유

- 프로그램 실행 중 공통 변수에 대한 동시 업데이트 진행으로 인한 문제 발생
    - 공통 변수 balance가 있고 한 스레드에서는 +, 한 스레드에서는 -을 동시에 진행

### 3. 데이터 불일치 해결 방법

- 한번에 한 스레드만 업데이트 하도록 한다 → **임계구역 문제 해결**
    - 임계구역의 코드가 atomic 하게 처리 되어야 한다. (더이상 쪼갤 수 없는 원자, 한 덩어리로 처리)

1. **임계 구역 문제 해결 조건 수행**
    1. **상호배제(Mutual exclusion)** : 하나의 스레드가 공통 변수를 업데이트 할 때 다른 스레드가 동시에 임계구역에 들어 갈 수 없다.
    2. **진행(Progress)** : 어느 스레드가 들어 갈 것인가 결정은 유한 시간 내에 일어나야 한다.
    3. **유한대기(Bounded waiting)** : 어느 스레드라도 유한 시간 내에 임계구역에 들어 갈 수 있다.
2. 프로세스 실행 순서를 우리가 직접 제어
3. Busy wait 등 비효율성을 제거

## 4. 동기화 도구

### 1. 세마포어(Semaphores)

### 2. 모니터(Monitors)

<강의 - [http://www.kocw.net/home/search/kemView.do?kemId=978503](http://www.kocw.net/home/search/kemView.do?kemId=978503)>