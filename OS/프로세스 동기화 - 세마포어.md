# 프로세스 동기화 - 세마포어

## 1. 세마포어(Semaphores)

### 1. 세마포어란?

- (철도의) 까치발 신호기, 시그널, 수기 신호
- (전통적인) 프로세스 동기화 문제 해결을 위한 소프트웨어 도구

### 2. 세마포어 구조

- 정수형 변수 + 두 개의 동작(P, V)
    
    ```java
    class Semaphore {
    	// 정수형 변수	
    	int value;
    	Semaphore(int value){
    			...
    	}
    	// 동작 P(Proberen)
    	void acquire(){
    		value--;
    		if(value < 0){
    			add this process/thread to list;
    			block;
    		}
    	}
    	// 동작 V(Verhogen)
    	void release(){
    		value++;
    		if(value <=0 ){
    			remove a process P from list;
    			wakeup P;
    		}
    	}
    }
    ```
    

### 3. 일반적 사용 1 : 상호배제(Mutal exclusion)

![2](https://user-images.githubusercontent.com/97429679/169874232-da64acbe-347b-4bd0-83aa-dbfead909642.png)

- 은행 계좌 문제 예제
    
    ```java
    package synchronization;
    
    import java.util.concurrent.Semaphore;
    
    public class BankAccount {
    	int balance;
    	
    	Semaphore sem;
    	BankAccount(){
    		sem = new Semaphore(1);
    	}
    	
    	// 세마포어 적용
    	void deposit(int n) {
    		try {
    			sem.acquire();
    		} catch (InterruptedException e) {
    			e.printStackTrace();
    		}
    		int temp = balance + n;
    		System.out.print("+");
    		balance = temp;
    		sem.release();
    	}
    	
    	// 세마포어 적용
    	void withdraw(int n) {
    		try {
    			sem.acquire();
    		} catch (InterruptedException e) {
    			e.printStackTrace();
    		}
    		int temp = balance - n;
    		System.out.print("-");
    		balance = temp;
    		sem.release();
    	}
    
    	int getBalance() {
    		return balance;
    	}
    }
    ```
    
    ```java
    package synchronization;
    
    public class Parent extends Thread{
    	BankAccount b;
    	Parent(BankAccount b){
    		this.b = b;
    	}
    	public void run() {
    		for(int i = 0 ; i < 1000; i++) {
    			b.deposit(1000);
    		}
    	}
    }
    ```
    
    ```java
    package synchronization;
    
    public class Child extends Thread {
    	BankAccount b;
    	Child(BankAccount b){
    		this.b = b;
    	}
    	public void run() {
    		for(int i = 0; i < 1000; i++) {
    			b.withdraw(1000);
    		}
    	}
    }
    ```
    
    ```java
    package synchronization;
    
    public class Test {
    
    	public static void main(String[] args) throws InterruptedException {
    		BankAccount b = new BankAccount();
    		Parent p = new Parent(b);
    		Child c = new Child(b);
    		p.start();
    		c.start();
    		p.join();
    		c.join();
    		System.out.println("\n");
    		System.out.println("balance = " + b.getBalance());
    	}
    }
    ```
    
- 예제 결과
    - 실행 1
        
        ```
        +++++---------------+++++-----------------------------------+++++++++++++++----------------------+++++++++---------------------------------------------------------------+++++++++++++++++++--------+-----------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----+++++++++++++++--------++++++++--------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------+++++++-------++++++++++---------------------------------------------------------------------------------------------+++++++-------++++++++--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------
        
        balance = 0
        ```
        
    - 실행 2
        
        ```
        ++++------+++++++++++++++-----+++++++++++++++++++++++++++----------------+++++++--------------------------------------------------------++++++++++++++++++++++++++++++++++++--------++++++++------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------+++++++--------++++++++-------++++++++----------------------+++++++-------++++++++------------------++--------------++++++++++++++++++++++++++++++++++--+----------------------------------------------------------+-------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-------------------------------------------------------------------
        
        balance = 0
        ```
        
    - 실행 3
        
        ```
        +++-------+++++++++------++++++++++++++++++++++++--------------------------++++++++++++++++++++++-------+++++++++++++++++++++++++++++++-------------------------------------------------------+++++++++++++++++++++++++++++++++++------++++++++++++++++++++++++++++++++++++++++++--------++++++++-++++++++++++++++++++++++-------++++++++--------++++++--------+++++------++++++--------+++++++++--------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++----------------------------------------------------------------------++++++++++++++++++++++++++++++++++++++++++++++++++++-------++++++++-------+++++++---------++++++--------++++++---------+++++++------++++++-------+++++++-------+++++++-------++++++-------+++++++++-------+++++++-------+++++++-------+++++++-------+++++++-------+++++++-------+++++++-------+-------+++++++-------+++++++-------+++++++-------+++++++-------+++++++-------+++++++-------++++++++-------++-------+++++++-------++++++++++++++++++---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+++++++++++++++-------++++++++-----+++++++----+++++++++-------++++++++------++++-----++++++++-------+++++++-----++++++++----++++++++-----++++++++----++++++++-----++++++++----++++++-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
        
        balance = 0
        ```
        

### 4. 일반적 사용 2 : 순서 제어(Ordering)

![3](https://user-images.githubusercontent.com/97429679/169874236-5b6db7d6-c748-4b32-8bcb-386b5638307b.png)

1. **은행 계좌 문제 예제 (항상 입금 먼저 = Parent 먼저)**
    
    ```java
    package synchronization;
    
    import java.util.concurrent.Semaphore;
    
    public class BankAccount {
    	int balance;
    	
    	Semaphore sem;
    	Semaphore sem2;
    	BankAccount(){
    		sem = new Semaphore(1);
    		sem2 = new Semaphore(0);
    	}
    	
    	void deposit(int n) {
    		try {
    			sem.acquire();
    		} catch (InterruptedException e) {
    			e.printStackTrace();
    		}
    		int temp = balance + n;
    		System.out.print("+");
    		balance = temp;
    		sem.release();
    		sem2.release();
    		// 입금 실행 후 출금 wake up
    	}
    	void withdraw(int n) {
    		try {
    			// 입금보다 먼저 실행시 block
    			sem2.acquire();
    			sem.acquire();
    		} catch (InterruptedException e) {
    			e.printStackTrace();
    		}
    		int temp = balance - n;
    		System.out.print("-");
    		balance = temp;
    		sem.release();
    	}
    	int getBalance() {
    		return balance;
    	}
    }
    ```
    
    - 나머지는 위와 같음
- 예제 결과
    
    ```
    +-+-+-+-+-+-+-+-+-++++++++++++++--------------+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++---------------------------------------------------------------------------------------------------------------------------------------------------------------++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    
    balance = 0
    ```
    
1. **입출금 교대로 (P-C-P-C-P-C-…)**
    
    ```java
    package synchronization;
    
    import java.util.concurrent.Semaphore;
    
    public class BankAccount {
    	int balance;
    	
    	Semaphore sem;
    	Semaphore dsem;
    	Semaphore wsem;
    	BankAccount(){
    		sem = new Semaphore(1);
    		dsem = new Semaphore(0);
    		wsem = new Semaphore(0);
    	}
    	
    	void deposit(int n) {
    		try {
    			sem.acquire();
    		int temp = balance + n;
    		System.out.print("+");
    		balance = temp;
    		sem.release();
    		wsem.release();
    		dsem.acquire();
    		} catch (InterruptedException e) {
    			e.printStackTrace();
    		}
    	}
    	void withdraw(int n) {
    		try {
    			wsem.acquire();
    			sem.acquire();
    		} catch (InterruptedException e) {
    			e.printStackTrace();
    		}
    		int temp = balance - n;
    		System.out.print("-");
    		balance = temp;
    		sem.release();
    		dsem.release();
    	}
    	int getBalance() {
    		return balance;
    	}
    }
    ```
    
    - 나머지 위와 같음
- 예제 결과
    
    ```
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-
    
    balance = 0
    ```
    

<강의 - [http://www.kocw.net/home/search/kemView.do?kemId=978503](http://www.kocw.net/home/search/kemView.do?kemId=978503)>
